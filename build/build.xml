<?xml version="1.0" encoding="UTF-8"?>  
<project name="authorization" basedir="." xmlns:sf="antlib:com.salesforce" default="authorize">

   <property environment="env"/>
	<property file="buildConfig\property\build.properties"/>

	<taskdef resource="com/salesforce/antlib.xml" uri="antlib:com.salesforce">
		<classpath>
			<pathelement location="buildConfig/lib/ant-salesforce.jar" />
		</classpath>
	</taskdef>
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpath="${ant.contrib.jar}"/>

   <target name="authorize">
        <runJWTAuth/>
	</target>
   <macrodef name="runJWTAuth" description="Authorizes a Salesforce org using the JWT flow">
		<sequential>
         <echo>******************* AUTHORIZE THE ORG - START ******************* ${line.separator}</echo>

			<mkdir dir="buildConfig/certificate"/>
			<touch file="buildConfig/certificate/server.key"/>
			<echo file="buildConfig/certificate/server.key" message="${privateKey}"/>
			<replace file="buildConfig/certificate/server.key" token="*" value="${line.separator}"/>
			
	
			<trycatch>
				<try>
					<!--JWTAuth.bat -->
         		<!-- <exec executable='JWTAuth.bat' errorproperty="SFDX.auth.error" outputproperty="SFDX.auth.output" resultproperty="SFDX.auth.result" failonerror="true"/> -->
					<exec executable="cmd" errorproperty="SFDX.auth.error" outputproperty="SFDX.auth.output" resultproperty="SFDX.auth.result" failonerror="true">
						<arg line="/c " />
						<arg line="sf org login jwt -o ${username} -f ${jwtKeyFile} -i ${clientId} --json --loglevel error -r ${instanceurl} "/>
					</exec>
				</try>
				<catch>
               <echo>Error  = ${SFDX.auth.error}</echo>
					<echo>Result = ${SFDX.auth.result}</echo>
               <echo>Output = ${SFDX.auth.output}</echo>
				</catch>
		   </trycatch>
			<if>
				<equals arg1="${SFDX.auth.result}" arg2="0"/>
				<then>
					<!-- <echo>Result = ${SFDX.auth.result}</echo>
            	<echo>Output = ${SFDX.auth.output}</echo> -->
					<echo>Status = SUCCESS</echo>	
				</then>
				<else>
					<echo>Status = FAILURE</echo>
				</else>
			</if>
         <echo>******************* AUTHORIZE THE ORG - END ******************* ${line.separator}</echo>
		</sequential>
   </macrodef>
</project>