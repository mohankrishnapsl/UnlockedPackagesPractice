<?xml version="1.0" encoding="UTF-8"?>
<project name="metadata" basedir="." xmlns:sf="antlib:com.salesforce">

   <property environment="env"/>
	<property name="property.file.path" value="CISupport/Sandbox/Sandbox_default.properties"/>
	<property file="CISupport/Sandbox/Sandbox_default.properties"/>

	<taskdef resource="com/salesforce/antlib.xml" uri="antlib:com.salesforce">
		<classpath>
			<pathelement location="CISupport/lib/ant-salesforce.jar" />
		</classpath>
	</taskdef>
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpath="CISupport/lib/ant-contrib-1.0b3.jar"/>
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpath="${ant.contrib.jar}" />

   <target name="startCICD">
		<sequential>
         <!--call macrodef - runJWTAuth-->
         <runJWTAuth/>
      </sequential>
	</target>

   <!-- runJWTAuth macrodef-->
   <macrodef name="runJWTAuth" description="Authorizes a Salesforce org using the JWT flow">
		<sequential>
			<trycatch>
				<try>
					<!--JWTAuth.bat-->
               <exec executable="JWTAuth.bat" errorproperty="SFDX.auth.error" outputproperty="SFDX.auth.output" resultproperty="SFDX.auth.result" failonerror="true"/>
					<!-- <exec executable="cmd" errorproperty="SFDX.auth.error" outputproperty="SFDX.auth.output" resultproperty="SFDX.auth.result" failonerror="true">
						<arg line="/c " />
						<arg line="sf org login jwt"/>
						<arg line=" -o ${sfsb.username}"/>
						<arg line=" -f ${jwtKeyFile}"/>
						<arg line=" -i ${clientId}"/>
						<arg line="  - -json"/>
						<arg line="  - -loglevel error"/>
						<arg line=" -r ${sfsb.instanceurl}"/>
					</exec> -->
				</try>
				<catch>
               <echo>Authorization Error Property : ${SFDX.auth.error}</echo>
					<echo>Authorization Result Property : ${SFDX.auth.result}</echo>
					<echo>Authorization Output Property : ${line.separator} ${SFDX.auth.output}</echo>
				</catch>
		   </trycatch>

			<echo>Authorization Result Property : ${SFDX.auth.result}</echo>
			<echo>Authorization Output Property : ${line.separator} ${SFDX.auth.output}</echo>
      
			<if>
				<equals arg1="${SFDX.auth.result}" arg2="0"/>
				<then>
					<echo>Authorization status : SUCCESS</echo>
				</then>
				<else>
					<echo>Authorization status : FAILURE</echo>
				</else>
			</if>
		</sequential>
    </macrodef>

</project>